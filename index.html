<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inkwell - Modern Blogging Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .glass-card {
        background: rgba(42, 50, 68, 0.5);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .sidebar-glass {
        background: rgba(30, 41, 59, 0.6);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-right: 1px solid rgba(255, 255, 255, 0.1);
      }
      .main-content::-webkit-scrollbar {
        width: 8px;
      }
      .main-content::-webkit-scrollbar-track {
        background: transparent;
      }
      .main-content::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 10px;
      }
      .main-content::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }
      .loading-spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid #fff;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-slate-900 text-slate-300 overflow-hidden">
    <div id="app-container" class="flex h-screen">
      <!-- Left Sidebar -->
      <aside
        class="w-64 h-full sidebar-glass p-6 flex-shrink-0 hidden md:flex flex-col justify-between"
      >
        <div>
          <h1 class="text-2xl font-bold text-white mb-10">Inkwell</h1>
          <nav class="space-y-4">
            <a
              href="#"
              id="nav-home"
              class="flex items-center space-x-3 text-white bg-slate-700/50 px-3 py-2 rounded-lg"
            >
              <i data-lucide="layout-dashboard"></i>
              <span>Discover</span>
            </a>
            <a
              href="#"
              id="nav-trending"
              class="flex items-center space-x-3 hover:text-white hover:bg-slate-700/50 px-3 py-2 rounded-lg transition-colors"
            >
              <i data-lucide="flame"></i>
              <span>Trending</span>
            </a>
            <a
              href="#"
              id="nav-profile"
              class="flex items-center space-x-3 hover:text-white hover:bg-slate-700/50 px-3 py-2 rounded-lg transition-colors"
            >
              <i data-lucide="user"></i>
              <span>My Profile</span>
            </a>
          </nav>

          <h2
            class="text-sm font-semibold tracking-widest text-slate-400 mt-10 mb-4"
          >
            CATEGORY
          </h2>
          <nav class="space-y-4">
            <a
              href="#"
              class="flex items-center space-x-3 hover:text-white transition-colors"
            >
              <i data-lucide="code"></i>
              <span>Technology</span>
            </a>
            <a
              href="#"
              class="flex items-center space-x-3 hover:text-white transition-colors"
            >
              <i data-lucide="plane"></i>
              <span>Travel</span>
            </a>
            <a
              href="#"
              class="flex items-center space-x-3 hover:text-white transition-colors"
            >
              <i data-lucide="pizza"></i>
              <span>Lifestyle</span>
            </a>
          </nav>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 flex flex-col h-screen">
        <!-- Header -->
        <header
          class="flex-shrink-0 bg-slate-900/50 backdrop-blur-sm z-10 flex items-center justify-between p-4 md:p-6 border-b border-slate-700/50"
        >
          <div class="relative w-full max-w-md">
            <i
              data-lucide="search"
              class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"
            ></i>
            <input
              type="text"
              id="search-bar"
              placeholder="Search articles or authors..."
              class="w-full bg-slate-800/80 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="flex items-center space-x-4">
            <button
              id="create-post-btn"
              class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
            >
              <i data-lucide="plus-circle" class="w-5 h-5"></i>
              <span class="hidden sm:inline">Create Post</span>
            </button>
            <div class="flex items-center space-x-3 cursor-pointer">
              <img
                id="current-user-avatar-header"
                src=""
                alt="User"
                class="w-10 h-10 rounded-full"
              />
              <div>
                <span
                  id="current-user-name-header"
                  class="text-white font-semibold"
                ></span>
                <i data-lucide="chevron-down" class="inline"></i>
              </div>
            </div>
          </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
          <!-- Center Content Area -->
          <div
            id="main-content-area"
            class="flex-1 p-6 overflow-y-auto main-content"
          >
            <!-- Dynamic Views will be injected here -->
            <div id="home-view"></div>
            <div id="article-view" class="hidden"></div>
            <div id="profile-view" class="hidden"></div>
            <div id="create-edit-view" class="hidden"></div>
            <div id="search-results-view" class="hidden"></div>
          </div>

          <!-- Right Sidebar -->
          <aside
            class="w-80 h-full glass-card p-6 flex-shrink-0 hidden lg:block overflow-y-auto main-content"
          >
            <!-- Popular Authors -->
            <div id="popular-authors-container">
              <h3 class="text-lg font-semibold text-white mb-4">
                Popular Authors
              </h3>
              <div id="popular-authors-list" class="space-y-4">
                <!-- JS will populate this -->
              </div>
            </div>
            <!-- Popular Tags -->
            <div id="popular-tags-container" class="mt-8">
              <h3 class="text-lg font-semibold text-white mb-4">
                Popular Topics
              </h3>
              <div id="popular-tags-list" class="flex flex-wrap gap-2">
                <!-- JS will populate this -->
              </div>
            </div>
          </aside>
        </div>
      </main>
    </div>

    <!-- Social Share Modal -->
    <div
      id="share-modal"
      class="fixed inset-0 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center hidden z-50"
    >
      <div class="glass-card rounded-xl p-8 max-w-sm w-full relative">
        <button
          id="close-share-modal"
          class="absolute top-4 right-4 text-slate-400 hover:text-white"
        >
          <i data-lucide="x"></i>
        </button>
        <h3 class="text-xl font-bold text-white text-center mb-6">
          Share this article
        </h3>
        <div class="flex justify-center space-x-4">
          <a
            href="#"
            target="_blank"
            class="share-link-twitter w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center hover:bg-sky-500 transition-colors"
            ><i data-lucide="twitter" class="w-8 h-8"></i
          ></a>
          <a
            href="#"
            target="_blank"
            class="share-link-facebook w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center hover:bg-blue-600 transition-colors"
            ><i data-lucide="facebook" class="w-8 h-8"></i
          ></a>
          <a
            href="#"
            target="_blank"
            class="share-link-linkedin w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center hover:bg-blue-800 transition-colors"
            ><i data-lucide="linkedin" class="w-8 h-8"></i
          ></a>
          <a
            href="#"
            target="_blank"
            class="share-link-reddit w-16 h-16 bg-slate-700 rounded-full flex items-center justify-center hover:bg-orange-500 transition-colors"
            ><i data-lucide="facebook"></i
          ></a>
        </div>
        <div class="mt-6 relative">
          <input
            type="text"
            id="share-url-input"
            readonly
            class="w-full bg-slate-700/80 border border-slate-600 rounded-lg pl-3 pr-12 py-2 text-white"
          />
          <button
            id="copy-share-url"
            class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-white p-1"
          >
            <i data-lucide="copy"></i>
          </button>
          <span
            id="copy-feedback"
            class="absolute -bottom-6 left-1/2 -translate-x-1/2 text-sm text-green-400 opacity-0 transition-opacity"
            >Copied!</span
          >
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          // Replace with your Firebase project configuration
          apiKey: "AIzaSyBnfH6QG71y4jtd6EBIvRwqj9zswNOs66k",
          authDomain: "attender-71a9f.firebaseapp.com",
          databaseURL: "https://attender-71a9f-default-rtdb.firebaseio.com",
          projectId: "attender-71a9f",
          storageBucket: "attender-71a9f.firebasestorage.app",
          messagingSenderId: "773468419469",
          appId: "1:773468419469:web:029ed58b7b67f9a95fb9c4",
          measurementId: "G-VY3ZLPF9LG",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- DATA MANAGEMENT ---
        let db = {
          users: [],
          articles: [],
          comments: [],
        };
        const CURRENT_USER_ID = "user1";

        // Firebase Database Reference
        const dbRef = {
          users: database.ref("users"),
          articles: database.ref("articles"),
          comments: database.ref("comments"),
        };

        // Initialize Firebase Database
        function initDatabase() {
          // Set up real-time listeners for data changes
          dbRef.users.on("value", (snapshot) => {
            const data = snapshot.val();
            if (data) {
              db.users = Object.keys(data).map((key) => ({
                id: key,
                ...data[key],
              }));
              renderCurrentUserHeader();
              renderSidebars();
            }
          });

          dbRef.articles.on("value", (snapshot) => {
            const data = snapshot.val();
            if (data) {
              db.articles = Object.keys(data).map((key) => ({
                id: key,
                ...data[key],
              }));
              // Check if we're on the home view and re-render if needed
              if (
                !document
                  .getElementById("home-view")
                  .classList.contains("hidden")
              ) {
                renderHome();
              }
            }
          });

          dbRef.comments.on("value", (snapshot) => {
            const data = snapshot.val();
            if (data) {
              db.comments = Object.keys(data).map((key) => ({
                id: key,
                ...data[key],
              }));
            }
          });

          // Check if we need to initialize with default data
          dbRef.users.once("value").then((snapshot) => {
            if (!snapshot.exists()) {
              initializeDefaultData();
            }
          });
        }

        function initializeDefaultData() {
          // Default users
          const defaultUsers = {
            user1: {
              name: "Thomas",
              avatar: "https://i.pravatar.cc/150?u=user1",
              followers: 1302,
              following: 150,
            },
            user2: {
              name: "Andy William",
              avatar: "https://i.pravatar.cc/150?u=user2",
              followers: 980,
              following: 210,
            },
            user3: {
              name: "Johnny Wise",
              avatar: "https://i.pravatar.cc/150?u=user3",
              followers: 2400,
              following: 89,
            },
            user4: {
              name: "Budi Holic",
              avatar: "https://i.pravatar.cc/150?u=user4",
              followers: 500,
              following: 50,
            },
          };

          // Default articles
          const defaultArticles = {
            article1: {
              authorId: "user1",
              title: "How to do Basic Jumping and how to landing safely",
              content:
                'Skateboarding is an action sport originating in the United States that involves riding and performing tricks using a skateboard, as well as a recreational activity, an art form, an entertainment industry job, and a method of transportation. \n\nLearning to jump, or "ollie," is a fundamental skill. It starts with foot placement. Your back foot should be on the tail of the board, and your front foot should be just behind the front bolts. Bend your knees deeply to prepare for the jump.',
              tags: ["skateboard", "tutorial", "safety"],
              likes: ["user2", "user3"],
              views: 125908,
              createdAt: new Date("2025-10-15T10:00:00Z").toISOString(),
              image:
                "https://images.unsplash.com/photo-1547425260-76bcadfb4f2c?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600",
            },
            article2: {
              authorId: "user2",
              title: "Basic how to ride your skateboard comfortably",
              content:
                "Comfort on a skateboard comes from balance and practice. Start by just standing on the board on a soft surface like grass to get a feel for it. Then, move to a flat, paved surface. Push off with one foot while the other stays on the board. Keep your knees slightly bent and your arms out to help with balance. The more time you spend on the board, the more comfortable you will become.",
              tags: ["skateboard", "basics"],
              likes: ["user1", "user3", "user4"],
              views: 47887,
              createdAt: new Date("2025-10-13T14:30:00Z").toISOString(),
              image:
                "https://images.unsplash.com/photo-1511993226335-36b4895a60b9?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600",
            },
            article3: {
              authorId: "user3",
              title: "Prepare for your first skateboard jump",
              content:
                'Before attempting your first real jump, practice the motions without the board. A good "box jump" can help build the explosive power needed. On the board, practice popping the tail down without jumping. This helps you understand the board\'s mechanics. Safety gear is paramount: a helmet, knee pads, and elbow pads can save you from serious injury.',
              tags: ["tutorial", "jump", "safety"],
              likes: ["user1"],
              views: 125908,
              createdAt: new Date("2025-10-10T09:00:00Z").toISOString(),
              image:
                "https://images.unsplash.com/photo-1520046622564-9a8c1f3f9b28?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=600",
            },
          };

          // Default comments
          const defaultComments = {
            comment1: {
              articleId: "article1",
              authorId: "user2",
              content: "Great tips! This really helped me get started.",
              createdAt: new Date("2025-10-15T11:00:00Z").toISOString(),
            },
            comment2: {
              articleId: "article1",
              authorId: "user3",
              content: "Safety first is the most important message. Well said.",
              createdAt: new Date("2025-10-15T12:30:00Z").toISOString(),
            },
          };

          // Set default data in Firebase
          dbRef.users.set(defaultUsers);
          dbRef.articles.set(defaultArticles);
          dbRef.comments.set(defaultComments);
        }

        // Firebase save functions
        function saveUser(userId, userData) {
          return dbRef.users.child(userId).set(userData);
        }

        function saveArticle(articleId, articleData) {
          return dbRef.articles.child(articleId).set(articleData);
        }

        function saveComment(commentId, commentData) {
          return dbRef.comments.child(commentId).set(commentData);
        }

        function deleteArticle(articleId) {
          return dbRef.articles.child(articleId).remove();
        }

        function deleteComment(commentId) {
          return dbRef.comments.child(commentId).remove();
        }

        // --- UTILITY FUNCTIONS ---
        const getUser = (userId) => db.users.find((u) => u.id === userId);
        const timeAgo = (date) => {
          const seconds = Math.floor((new Date() - new Date(date)) / 1000);
          let interval = seconds / 31536000;
          if (interval > 1) return Math.floor(interval) + " years ago";
          interval = seconds / 2592000;
          if (interval > 1) return Math.floor(interval) + " months ago";
          interval = seconds / 86400;
          if (interval > 1) return Math.floor(interval) + " days ago";
          interval = seconds / 3600;
          if (interval > 1) return Math.floor(interval) + " hours ago";
          interval = seconds / 60;
          if (interval > 1) return Math.floor(interval) + " minutes ago";
          return Math.floor(seconds) + " seconds ago";
        };

        // --- UI RENDERING ---
        const homeView = document.getElementById("home-view");
        const articleView = document.getElementById("article-view");
        const profileView = document.getElementById("profile-view");
        const createEditView = document.getElementById("create-edit-view");
        const searchResultsView = document.getElementById(
          "search-results-view"
        );

        function switchView(viewName) {
          [
            homeView,
            articleView,
            profileView,
            createEditView,
            searchResultsView,
          ].forEach((v) => v.classList.add("hidden"));
          document
            .getElementById(`${viewName}-view`)
            .classList.remove("hidden");
          document.getElementById("main-content-area").scrollTop = 0;
        }

        function renderCurrentUserHeader() {
          const user = getUser(CURRENT_USER_ID);
          if (user) {
            document.getElementById("current-user-avatar-header").src =
              user.avatar;
            document.getElementById("current-user-name-header").textContent =
              user.name;
          }
        }

        function renderHome(articlesToRender = db.articles) {
          if (articlesToRender.length === 0) {
            homeView.innerHTML = `
              <div class="text-center py-10">
                <div class="loading-spinner"></div>
                <p class="text-slate-400 mt-4">Loading articles...</p>
              </div>
            `;
            return;
          }

          const sortedArticles = [...articlesToRender].sort(
            (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
          );
          homeView.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6">Trending</h2>
            <div class="space-y-4">
                ${sortedArticles
                  .map((article, index) =>
                    renderArticleCard(article, index + 1)
                  )
                  .join("")}
            </div>
        `;
          lucide.createIcons();
        }

        function renderArticleCard(article, index) {
          const author = getUser(article.authorId);
          const isLiked =
            article.likes && article.likes.includes(CURRENT_USER_ID);
          return `
            <div class="glass-card rounded-xl p-4 flex items-center gap-6">
                <span class="text-3xl font-bold text-slate-600">${String(
                  index
                ).padStart(2, "0")}</span>
                <img src="${
                  article.image
                }" alt="Article thumbnail" class="w-40 h-24 object-cover rounded-lg">
                <div class="flex-1">
                    <a href="#" class="block text-lg font-semibold text-white hover:text-blue-400 transition-colors article-link" data-id="${
                      article.id
                    }">
                        ${article.title}
                    </a>
                    <div class="text-sm text-slate-400 mt-2 flex items-center gap-4">
                        <span><i data-lucide="eye" class="inline w-4 h-4 mr-1"></i>${
                          article.views ? article.views.toLocaleString() : 0
                        } views</span>
                        <span><i data-lucide="thumbs-up" class="inline w-4 h-4 mr-1"></i>${
                          article.likes ? article.likes.length : 0
                        } likes</span>
                    </div>
                    <div class="mt-3 flex items-center gap-3">
                        <img src="${author ? author.avatar : ""}" alt="${
            author ? author.name : "Unknown"
          }" class="w-8 h-8 rounded-full">
                        <div>
                            <span class="text-white font-medium">${
                              author ? author.name : "Unknown"
                            }</span>
                            <span class="text-slate-400 text-sm block">${timeAgo(
                              article.createdAt
                            )}</span>
                        </div>
                    </div>
                </div>
                <button class="like-btn p-2 rounded-full self-start ${
                  isLiked
                    ? "text-red-500 bg-red-500/10"
                    : "text-slate-400 hover:bg-slate-700"
                }" data-id="${article.id}">
                    <i data-lucide="heart"></i>
                </button>
            </div>
        `;
        }

        function renderArticleDetail(articleId) {
          const article = db.articles.find((a) => a.id === articleId);
          if (!article) {
            switchView("home");
            return;
          }
          const author = getUser(article.authorId);
          const isLiked =
            article.likes && article.likes.includes(CURRENT_USER_ID);

          // Increment views in Firebase
          const updatedViews = (article.views || 0) + 1;
          saveArticle(articleId, {
            ...article,
            views: updatedViews,
          });

          articleView.innerHTML = `
            <div class="max-w-4xl mx-auto">
                <button id="back-to-home" class="flex items-center gap-2 text-slate-400 hover:text-white mb-6">
                    <i data-lucide="arrow-left"></i> Back to Discover
                </button>
                <h1 class="text-4xl font-bold text-white mb-4">${
                  article.title
                }</h1>
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <img src="${author ? author.avatar : ""}" alt="${
            author ? author.name : "Unknown"
          }" class="w-12 h-12 rounded-full">
                        <div>
                            <p class="text-white font-semibold text-lg">${
                              author ? author.name : "Unknown"
                            }</p>
                            <p class="text-slate-400">${timeAgo(
                              article.createdAt
                            )}</p>
                        </div>
                    </div>
                    ${
                      article.authorId === CURRENT_USER_ID
                        ? `
                    <div class="flex gap-2">
                        <button class="edit-article-btn p-2 rounded-lg bg-slate-700 hover:bg-slate-600" data-id="${article.id}"><i data-lucide="edit"></i></button>
                        <button class="delete-article-btn p-2 rounded-lg bg-red-800 hover:bg-red-700" data-id="${article.id}"><i data-lucide="trash-2"></i></button>
                    </div>
                    `
                        : ""
                    }
                </div>
                
                <img src="${
                  article.image
                }" class="w-full h-96 object-cover rounded-xl mb-8">

                <div class="prose prose-invert prose-lg max-w-none text-slate-300">
                   ${article.content.replace(/\n/g, "<br><br>")}
                </div>

                <div class="mt-8 pt-6 border-t border-slate-700 flex items-center justify-between">
                     <div class="flex items-center gap-4 text-slate-400">
                        <button class="like-btn flex items-center gap-2 px-4 py-2 rounded-lg ${
                          isLiked
                            ? "text-red-500 bg-red-500/10"
                            : "hover:bg-slate-700"
                        }" data-id="${article.id}">
                            <i data-lucide="heart"></i> <span class="like-count">${
                              article.likes ? article.likes.length : 0
                            }</span> Likes
                        </button>
                        <div class="flex items-center gap-2">
                            <i data-lucide="message-square"></i> ${
                              db.comments.filter(
                                (c) => c.articleId === article.id
                              ).length
                            } Comments
                        </div>
                     </div>
                     <button class="share-btn flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-slate-700" data-id="${
                       article.id
                     }">
                         <i data-lucide="share-2"></i> Share
                     </button>
                </div>
                
                <!-- Comments Section -->
                <div id="comments-section" class="mt-10">
                    <h3 class="text-2xl font-bold text-white mb-6">Comments</h3>
                    <div class="glass-card p-4 rounded-lg">
                        <textarea id="new-comment-input" class="w-full bg-slate-800 border-slate-700 rounded-lg p-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="Write a comment..."></textarea>
                        <div class="text-right mt-2">
                            <button id="submit-comment-btn" data-id="${
                              article.id
                            }" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">Post Comment</button>
                        </div>
                    </div>
                    <div id="comments-list" class="mt-6 space-y-4">
                        ${renderComments(articleId)}
                    </div>
                </div>
            </div>
        `;
          switchView("article");
          lucide.createIcons();
        }

        function renderComments(articleId) {
          const comments = db.comments
            .filter((c) => c.articleId === articleId)
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
          if (comments.length === 0)
            return `<p class="text-slate-400 text-center py-4">No comments yet.</p>`;

          return comments
            .map((comment) => {
              const author = getUser(comment.authorId);
              return `
                <div class="flex gap-4">
                    <img src="${
                      author ? author.avatar : ""
                    }" class="w-10 h-10 rounded-full mt-1">
                    <div class="flex-1">
                        <div class="glass-card p-3 rounded-lg">
                           <div class="flex justify-between items-center">
                                <p class="font-semibold text-white">${
                                  author ? author.name : "Unknown"
                                }</p>
                                <span class="text-xs text-slate-400">${timeAgo(
                                  comment.createdAt
                                )}</span>
                           </div>
                           <p class="text-slate-300 mt-1">${comment.content}</p>
                        </div>
                    </div>
                </div>
            `;
            })
            .join("");
        }

        function renderCreateEditForm(articleId = null) {
          const article = articleId
            ? db.articles.find((a) => a.id === articleId)
            : null;
          const formTitle = article ? "Edit Article" : "Create New Post";
          const submitButtonText = article ? "Save Changes" : "Publish Post";

          createEditView.innerHTML = `
            <div class="max-w-4xl mx-auto">
                <h2 class="text-3xl font-bold text-white mb-6">${formTitle}</h2>
                <form id="article-form" data-editing-id="${articleId || ""}">
                    <div class="mb-4">
                        <label for="title" class="block text-slate-400 mb-2">Title</label>
                        <input type="text" id="title" name="title" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" value="${
                          article ? article.title : ""
                        }" required>
                    </div>
                    <div class="mb-4">
                        <label for="content" class="block text-slate-400 mb-2">Content</label>
                        <textarea id="content" name="content" rows="10" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" required>${
                          article ? article.content : ""
                        }</textarea>
                    </div>
                     <div class="mb-4">
                        <label for="image" class="block text-slate-400 mb-2">Image URL</label>
                        <input type="url" id="image" name="image" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" value="${
                          article ? article.image : ""
                        }" required>
                    </div>
                    <div class="mb-6">
                        <label for="tags" class="block text-slate-400 mb-2">Tags (comma-separated)</label>
                        <input type="text" id="tags" name="tags" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" value="${
                          article ? article.tags.join(", ") : ""
                        }">
                    </div>
                    <div class="flex justify-end gap-4">
                        <button type="button" id="cancel-edit-btn" class="px-6 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">Cancel</button>
                        <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-700">${submitButtonText}</button>
                    </div>
                </form>
            </div>
        `;
          switchView("create-edit");
        }

        function renderProfile(userId) {
          const user = getUser(userId);
          if (!user) {
            switchView("home");
            return;
          }

          const userArticles = db.articles
            .filter((a) => a.authorId === userId)
            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          profileView.innerHTML = `
            <div class="max-w-5xl mx-auto">
                <div class="glass-card rounded-xl p-8 flex flex-col md:flex-row items-center gap-8">
                    <img src="${
                      user.avatar
                    }" class="w-32 h-32 rounded-full border-4 border-slate-600">
                    <div class="text-center md:text-left">
                        <h2 class="text-3xl font-bold text-white">${
                          user.name
                        }</h2>
                        <div class="flex justify-center md:justify-start gap-6 mt-4 text-slate-400">
                            <span><strong class="text-white">${
                              userArticles.length
                            }</strong> Posts</span>
                            <span><strong class="text-white">${user.followers.toLocaleString()}</strong> Followers</span>
                            <span><strong class="text-white">${user.following.toLocaleString()}</strong> Following</span>
                        </div>
                    </div>
                </div>

                <h3 class="text-2xl font-bold text-white mt-10 mb-6">Articles by ${
                  user.name
                }</h3>
                <div class="space-y-4">
                    ${
                      userArticles.length > 0
                        ? userArticles
                            .map((article, index) =>
                              renderArticleCard(article, index + 1)
                            )
                            .join("")
                        : '<p class="text-slate-400 text-center py-4">This user hasn\'t posted anything yet.</p>'
                    }
                </div>
            </div>
        `;
          switchView("profile");
          lucide.createIcons();
        }

        function renderSearchResults(query) {
          const lowerQuery = query.toLowerCase();
          const foundArticles = db.articles.filter(
            (a) =>
              a.title.toLowerCase().includes(lowerQuery) ||
              a.content.toLowerCase().includes(lowerQuery) ||
              a.tags.some((t) => t.toLowerCase().includes(lowerQuery))
          );
          const foundAuthors = db.users.filter((u) =>
            u.name.toLowerCase().includes(lowerQuery)
          );

          searchResultsView.innerHTML = `
            <h2 class="text-3xl font-bold text-white mb-6">Search Results for "${query}"</h2>
            
            ${
              foundAuthors.length > 0
                ? `
                <h3 class="text-xl font-semibold text-white mb-4">Authors</h3>
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-8">
                    ${foundAuthors
                      .map(
                        (user) => `
                        <div class="glass-card p-4 rounded-lg text-center">
                            <img src="${user.avatar}" class="w-20 h-20 rounded-full mx-auto mb-2">
                            <p class="text-white font-semibold">${user.name}</p>
                            <button class="view-profile-btn mt-2 text-sm text-blue-400 hover:underline" data-id="${user.id}">View Profile</button>
                        </div>
                    `
                      )
                      .join("")}
                </div>
            `
                : ""
            }

            <h3 class="text-xl font-semibold text-white mb-4">Articles</h3>
            <div class="space-y-4">
                ${
                  foundArticles.length > 0
                    ? foundArticles
                        .map((article, index) =>
                          renderArticleCard(article, index + 1)
                        )
                        .join("")
                    : '<p class="text-slate-400 text-center py-4">No articles found.</p>'
                }
            </div>
        `;

          switchView("search-results");
          lucide.createIcons();
        }

        function renderSidebars() {
          // Popular Authors
          const popularAuthorsList = document.getElementById(
            "popular-authors-list"
          );
          const sortedAuthors = [...db.users]
            .sort((a, b) => b.followers - a.followers)
            .slice(0, 4);
          popularAuthorsList.innerHTML = sortedAuthors
            .map(
              (user) => `
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="${user.avatar}" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-semibold text-white">${user.name}</p>
                        <p class="text-sm text-slate-400">${user.followers.toLocaleString()} followers</p>
                    </div>
                </div>
                <button class="view-profile-btn text-blue-500 text-sm font-semibold hover:underline" data-id="${
                  user.id
                }">View</button>
            </div>
        `
            )
            .join("");

          // Popular Tags
          const popularTagsList = document.getElementById("popular-tags-list");
          const allTags = db.articles.flatMap((a) => a.tags || []);
          const tagCounts = allTags.reduce((acc, tag) => {
            acc[tag] = (acc[tag] || 0) + 1;
            return acc;
          }, {});
          const sortedTags = Object.entries(tagCounts)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 8);
          popularTagsList.innerHTML = sortedTags
            .map(
              ([tag]) => `
            <button class="bg-slate-700/80 px-3 py-1 rounded-full text-sm hover:bg-slate-600 transition-colors">${tag}</button>
        `
            )
            .join("");
        }

        // --- EVENT HANDLERS ---
        document.body.addEventListener("click", (e) => {
          // Article Links
          const articleLink = e.target.closest(".article-link");
          if (articleLink) {
            e.preventDefault();
            renderArticleDetail(articleLink.dataset.id);
          }

          // Back to Home
          if (e.target.closest("#back-to-home")) {
            e.preventDefault();
            renderHome();
            switchView("home");
          }

          // Like button
          const likeBtn = e.target.closest(".like-btn");
          if (likeBtn) {
            const articleId = likeBtn.dataset.id;
            const article = db.articles.find((a) => a.id === articleId);
            if (!article) return;

            const likes = article.likes || [];
            const likeIndex = likes.indexOf(CURRENT_USER_ID);

            if (likeIndex > -1) {
              likes.splice(likeIndex, 1);
            } else {
              likes.push(CURRENT_USER_ID);
            }

            // Update in Firebase
            saveArticle(articleId, {
              ...article,
              likes: likes,
            });
          }

          // Post Comment
          const submitCommentBtn = e.target.closest("#submit-comment-btn");
          if (submitCommentBtn) {
            const articleId = submitCommentBtn.dataset.id;
            const content = document.getElementById("new-comment-input").value;
            if (content.trim()) {
              const newComment = {
                id: "comment" + Date.now(),
                articleId,
                authorId: CURRENT_USER_ID,
                content: content.trim(),
                createdAt: new Date().toISOString(),
              };

              // Save to Firebase
              saveComment(newComment.id, newComment);
              document.getElementById("new-comment-input").value = "";
            }
          }

          // Create new post
          if (e.target.closest("#create-post-btn")) {
            renderCreateEditForm();
          }

          // Edit article
          const editArticleBtn = e.target.closest(".edit-article-btn");
          if (editArticleBtn) {
            renderCreateEditForm(editArticleBtn.dataset.id);
          }

          // Delete article
          const deleteArticleBtn = e.target.closest(".delete-article-btn");
          if (deleteArticleBtn) {
            if (confirm("Are you sure you want to delete this article?")) {
              const articleId = deleteArticleBtn.dataset.id;
              // Delete from Firebase
              deleteArticle(articleId);
              // Also delete associated comments
              db.comments
                .filter((c) => c.articleId === articleId)
                .forEach((comment) => deleteComment(comment.id));

              renderHome();
              switchView("home");
            }
          }

          // Cancel article edit/create
          if (e.target.closest("#cancel-edit-btn")) {
            const editingId =
              document.getElementById("article-form").dataset.editingId;
            if (editingId) {
              renderArticleDetail(editingId);
            } else {
              renderHome();
              switchView("home");
            }
          }

          // View profile
          const viewProfileBtn = e.target.closest(".view-profile-btn");
          if (viewProfileBtn) {
            e.preventDefault();
            renderProfile(viewProfileBtn.dataset.id);
          }
        });

        // --- Navigation ---
        document.getElementById("nav-home").addEventListener("click", (e) => {
          e.preventDefault();
          renderHome();
          switchView("home");
        });

        document
          .getElementById("nav-profile")
          .addEventListener("click", (e) => {
            e.preventDefault();
            renderProfile(CURRENT_USER_ID);
          });

        // --- Article Form Submission ---
        createEditView.addEventListener("submit", (e) => {
          if (e.target.id === "article-form") {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editingId = e.target.dataset.editingId;

            const articleData = {
              title: formData.get("title"),
              content: formData.get("content"),
              image: formData.get("image"),
              tags: formData
                .get("tags")
                .split(",")
                .map((t) => t.trim())
                .filter(Boolean),
              authorId: CURRENT_USER_ID,
              createdAt: editingId
                ? db.articles.find((a) => a.id === editingId).createdAt
                : new Date().toISOString(),
              likes: editingId
                ? db.articles.find((a) => a.id === editingId).likes || []
                : [],
              views: editingId
                ? db.articles.find((a) => a.id === editingId).views || 0
                : 0,
            };

            if (editingId) {
              // Update existing article
              saveArticle(editingId, articleData);
              renderArticleDetail(editingId);
            } else {
              // Create new article
              const newArticleId = "article" + Date.now();
              saveArticle(newArticleId, articleData);
              renderHome();
              switchView("home");
            }
          }
        });

        // --- Search ---
        const searchBar = document.getElementById("search-bar");
        searchBar.addEventListener("keyup", (e) => {
          if (e.key === "Enter") {
            const query = searchBar.value.trim();
            if (query) {
              renderSearchResults(query);
            }
          }
        });

        // --- Share Modal ---
        const shareModal = document.getElementById("share-modal");
        const closeShareModal = document.getElementById("close-share-modal");

        document.body.addEventListener("click", (e) => {
          const shareBtn = e.target.closest(".share-btn");
          if (shareBtn) {
            const articleId = shareBtn.dataset.id;
            const article = db.articles.find((a) => a.id === articleId);
            const url = `${
              window.location.href.split("#")[0]
            }#article=${articleId}`;
            const text = `Check out this article: ${article.title}`;

            shareModal.querySelector(
              ".share-link-twitter"
            ).href = `https://twitter.com/intent/tweet?url=${encodeURIComponent(
              url
            )}&text=${encodeURIComponent(text)}`;
            shareModal.querySelector(
              ".share-link-facebook"
            ).href = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
              url
            )}`;
            shareModal.querySelector(
              ".share-link-linkedin"
            ).href = `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(
              url
            )}&title=${encodeURIComponent(article.title)}`;
            shareModal.querySelector(
              ".share-link-reddit"
            ).href = `https://www.reddit.com/submit?url=${encodeURIComponent(
              url
            )}&title=${encodeURIComponent(article.title)}`;
            shareModal.querySelector("#share-url-input").value = url;
            shareModal.classList.remove("hidden");
          }
        });

        closeShareModal.addEventListener("click", () =>
          shareModal.classList.add("hidden")
        );
        shareModal.addEventListener("click", (e) => {
          if (e.target === shareModal) {
            shareModal.classList.add("hidden");
          }
        });

        document
          .getElementById("copy-share-url")
          .addEventListener("click", () => {
            const input = document.getElementById("share-url-input");
            input.select();
            document.execCommand("copy");
            const feedback = document.getElementById("copy-feedback");
            feedback.style.opacity = "1";
            setTimeout(() => {
              feedback.style.opacity = "0";
            }, 2000);
          });

        // --- INITIALIZATION ---
        function initializeApp() {
          initDatabase();
          renderHome();
          lucide.createIcons();
        }

        initializeApp();
      });
    </script>
  </body>
</html>
